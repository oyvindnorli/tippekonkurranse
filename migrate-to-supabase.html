<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migrer til Supabase</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .step {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        .step.completed {
            border-left-color: #22c55e;
            background: #f0fdf4;
        }
        .step.error {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #5568d3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .progress {
            margin: 20px 0;
        }
        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin: 20px 0;
        }
        .log div {
            margin: 2px 0;
        }
        .log .success { color: #22c55e; }
        .log .error { color: #ef4444; }
        .log .info { color: #60a5fa; }
        .log .warning { color: #fbbf24; }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #667eea;
            color: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .stat-card h3 {
            margin: 0 0 5px 0;
            font-size: 32px;
        }
        .stat-card p {
            margin: 0;
            opacity: 0.9;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Migrer data fra Firebase til Supabase</h1>

        <div class="step" id="step-firebase">
            <h3>Steg 1: Hent data fra Firebase</h3>
            <p>Logger inn med din Firebase-bruker og henter all data...</p>
            <button onclick="startMigration()" id="btnStart">Start migrasjon</button>
        </div>

        <div class="stats" id="firebaseStats" style="display:none;">
            <div class="stat-card">
                <h3 id="tipCount">0</h3>
                <p>Tips</p>
            </div>
            <div class="stat-card">
                <h3 id="matchCount">0</h3>
                <p>Matches</p>
            </div>
            <div class="stat-card">
                <h3 id="competitionCount">0</h3>
                <p>Konkurranser</p>
            </div>
        </div>

        <div class="log" id="log"></div>

        <div class="progress" id="progress" style="display:none;">
            <h3>Migrering p√•g√•r...</h3>
            <div style="background: #e5e7eb; height: 20px; border-radius: 10px; overflow: hidden;">
                <div id="progressBar" style="background: #667eea; height: 100%; width: 0%; transition: width 0.3s;"></div>
            </div>
            <p id="progressText" style="text-align: center; margin-top: 10px;">0%</p>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Firebase config (your existing config)
        const firebaseConfig = {
            apiKey: "AIzaSyBp3xGxAb7EikxhdDWBVnKYo59fgOlrC5A",
            authDomain: "tippekonkurranse-50e6b.firebaseapp.com",
            projectId: "tippekonkurranse-50e6b",
            storageBucket: "tippekonkurranse-50e6b.firebasestorage.app",
            messagingSenderId: "411055151338",
            appId: "1:411055151338:web:af33f03ba32f8f2f8a5326",
            measurementId: "G-P54EJRBN1T"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Initialize Supabase
        const { createClient } = supabase;
        const supabaseClient = createClient(
            'https://ntbhjbstmbnfiaywfkkz.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50YmhqYnN0bWJuZmlheXdma2t6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyOTYwNTAsImV4cCI6MjA3ODg3MjA1MH0.5R1QJZxXK5Rwdt2WPEKWAno1SBY6aFUQJPbwjOhar8E'
        );

        let migrationData = {
            users: [],
            tips: [],
            matches: [],
            competitions: [],
            participants: [],
            preferences: []
        };

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div class="${type}">[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateProgress(percent, text) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        async function startMigration() {
            try {
                document.getElementById('btnStart').disabled = true;
                document.getElementById('log').style.display = 'block';
                document.getElementById('progress').style.display = 'block';

                log('üöÄ Starter migrasjon...', 'info');

                // Wait for Firebase auth
                const user = firebase.auth().currentUser;
                if (!user) {
                    log('‚ùå Du m√• v√¶re logget inn i Firebase f√∏rst!', 'error');
                    log('‚ÑπÔ∏è √Öpne index.html og logg inn, deretter kj√∏r dette scriptet igjen.', 'info');
                    return;
                }

                log(`‚úÖ Logget inn som: ${user.email}`, 'success');
                updateProgress(5, 'Henter data fra Firebase...');

                // Fetch all data from Firebase
                await fetchFirebaseData(user.uid);

                updateProgress(40, 'Migrerer til Supabase...');

                // Migrate to Supabase
                await migrateToSupabase(user);

                updateProgress(100, '‚úÖ Migrasjon fullf√∏rt!');
                log('üéâ Alle data er migrert til Supabase!', 'success');

            } catch (error) {
                log(`‚ùå Feil: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function fetchFirebaseData(userId) {
            const db = firebase.firestore();

            log('üì• Henter tips...', 'info');
            const tipsSnapshot = await db.collection('tips')
                .where('userId', '==', userId)
                .get();
            migrationData.tips = tipsSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            document.getElementById('tipCount').textContent = migrationData.tips.length;
            log(`‚úÖ Hentet ${migrationData.tips.length} tips`, 'success');

            updateProgress(15, 'Henter kamper...');
            log('üì• Henter kamper...', 'info');
            const matchesSnapshot = await db.collection('matches').get();
            migrationData.matches = matchesSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            document.getElementById('matchCount').textContent = migrationData.matches.length;
            log(`‚úÖ Hentet ${migrationData.matches.length} kamper`, 'success');

            updateProgress(25, 'Henter konkurranser...');
            log('üì• Henter konkurranser...', 'info');
            const competitionsSnapshot = await db.collection('competitions').get();
            migrationData.competitions = competitionsSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            document.getElementById('competitionCount').textContent = migrationData.competitions.length;
            log(`‚úÖ Hentet ${migrationData.competitions.length} konkurranser`, 'success');

            updateProgress(30, 'Henter deltakere...');
            log('üì• Henter deltakere...', 'info');
            const participantsSnapshot = await db.collection('competitionParticipants').get();
            migrationData.participants = participantsSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            log(`‚úÖ Hentet ${migrationData.participants.length} deltakere`, 'success');

            updateProgress(35, 'Henter preferanser...');
            log('üì• Henter preferanser...', 'info');
            const prefsDoc = await db.collection('userPreferences').doc(userId).get();
            if (prefsDoc.exists) {
                migrationData.preferences = [{ userId, ...prefsDoc.data() }];
            }
            log(`‚úÖ Hentet preferanser`, 'success');

            document.getElementById('firebaseStats').style.display = 'grid';
        }

        async function migrateToSupabase(firebaseUser) {
            // Step 1: Create user in Supabase Auth
            log('üë§ Oppretter bruker i Supabase...', 'info');

            // First, sign up with email/password in Supabase
            // Note: You'll need to set a password
            const password = prompt('Velg et passord for Supabase (minst 6 tegn):');
            if (!password || password.length < 6) {
                throw new Error('Passord m√• v√¶re minst 6 tegn');
            }

            let supabaseUser;
            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email: firebaseUser.email,
                    password: password,
                });

                if (error) {
                    // User might already exist, try to sign in
                    const { data: signInData, error: signInError } = await supabaseClient.auth.signInWithPassword({
                        email: firebaseUser.email,
                        password: password,
                    });

                    if (signInError) {
                        throw new Error(`Kunne ikke logge inn: ${signInError.message}`);
                    }
                    supabaseUser = signInData.user;
                    log(`‚úÖ Logget inn i Supabase som: ${supabaseUser.email}`, 'success');
                } else {
                    supabaseUser = data.user;
                    log(`‚úÖ Opprettet bruker i Supabase: ${supabaseUser.email}`, 'success');
                }
            } catch (err) {
                log(`‚ö†Ô∏è Feil ved autentisering: ${err.message}`, 'warning');
                throw err;
            }

            updateProgress(45, 'Migrerer brukerdata...');

            // Step 2: Migrate user data
            log('üì§ Migrerer brukerdata...', 'info');
            const { error: userError } = await supabaseClient
                .from('users')
                .upsert({
                    id: supabaseUser.id,
                    email: firebaseUser.email,
                    display_name: firebaseUser.displayName || firebaseUser.email.split('@')[0]
                });

            if (userError) {
                log(`‚ö†Ô∏è Bruker finnes allerede eller feil: ${userError.message}`, 'warning');
            } else {
                log(`‚úÖ Brukerdata migrert`, 'success');
            }

            // Step 3: Migrate matches
            updateProgress(55, `Migrerer ${migrationData.matches.length} kamper...`);
            log(`üì§ Migrerer ${migrationData.matches.length} kamper...`, 'info');

            const matchesToInsert = migrationData.matches.map(m => ({
                id: parseInt(m.id),
                home_team: m.homeTeam,
                away_team: m.awayTeam,
                league_id: m.league || m.leagueId || 0,
                league_name: m.leagueName || '',
                season: m.season || 2024,
                commence_time: m.commence_time || m.date || new Date().toISOString(),
                status: m.status || 'NS',
                home_score: m.result?.home || null,
                away_score: m.result?.away || null,
                home_logo: m.homeLogo || null,
                away_logo: m.awayLogo || null,
                odds: m.odds || null,
                completed: m.completed || false,
                elapsed: m.elapsed || null
            }));

            // Insert in batches of 100
            for (let i = 0; i < matchesToInsert.length; i += 100) {
                const batch = matchesToInsert.slice(i, i + 100);
                const { error } = await supabaseClient
                    .from('matches')
                    .upsert(batch);

                if (error) {
                    log(`‚ö†Ô∏è Feil ved migrering av kamper batch ${i}: ${error.message}`, 'warning');
                }
                updateProgress(55 + (i / matchesToInsert.length * 15), `Migrert ${i + batch.length}/${matchesToInsert.length} kamper`);
            }
            log(`‚úÖ ${matchesToInsert.length} kamper migrert`, 'success');

            // Step 4: Migrate tips
            updateProgress(70, `Migrerer ${migrationData.tips.length} tips...`);
            log(`üì§ Migrerer ${migrationData.tips.length} tips...`, 'info');

            const tipsToInsert = migrationData.tips.map(t => ({
                user_id: supabaseUser.id,
                match_id: parseInt(t.matchId),
                home_score: t.homeScore,
                away_score: t.awayScore,
                home_team: t.homeTeam,
                away_team: t.awayTeam,
                odds: t.odds || null,
                timestamp: t.timestamp || new Date().toISOString()
            }));

            const { error: tipsError } = await supabaseClient
                .from('tips')
                .upsert(tipsToInsert);

            if (tipsError) {
                log(`‚ö†Ô∏è Feil ved migrering av tips: ${tipsError.message}`, 'warning');
            } else {
                log(`‚úÖ ${tipsToInsert.length} tips migrert`, 'success');
            }

            // Step 5: Migrate preferences
            if (migrationData.preferences.length > 0) {
                updateProgress(85, 'Migrerer preferanser...');
                log('üì§ Migrerer preferanser...', 'info');

                const { error: prefsError } = await supabaseClient
                    .from('user_preferences')
                    .upsert({
                        user_id: supabaseUser.id,
                        selected_leagues: migrationData.preferences[0].selectedLeagues || []
                    });

                if (prefsError) {
                    log(`‚ö†Ô∏è Feil ved migrering av preferanser: ${prefsError.message}`, 'warning');
                } else {
                    log(`‚úÖ Preferanser migrert`, 'success');
                }
            }

            updateProgress(95, 'Verifiserer migrasjon...');

            // Verify migration
            log('üîç Verifiserer migrasjon...', 'info');
            const { count: tipCount } = await supabaseClient
                .from('tips')
                .select('*', { count: 'exact', head: true })
                .eq('user_id', supabaseUser.id);

            log(`‚úÖ Verifisert: ${tipCount} tips i Supabase`, 'success');
        }
    </script>
</body>
</html>
