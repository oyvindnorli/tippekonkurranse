<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oppdater Round-info - Tippekonkurranse</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="unified-design.css">
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1a1a1a;
            margin-bottom: 10px;
        }
        .description {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        button {
            background: #0ea5e9;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover {
            background: #0284c7;
        }
        button:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }
        #log {
            margin-top: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
        }
        .success {
            color: #059669;
        }
        .error {
            color: #dc2626;
        }
        .info {
            color: #0284c7;
        }
    </style>
</head>
<body>
    <!-- Header injected by header.js -->
    <div id="headerContainer"></div>

    <div class="container">
        <h1>üîÑ Oppdater Round-informasjon</h1>
        <p class="description">
            Dette scriptet henter alle kamper fra Supabase, sl√•r opp round-info fra API-Football,
            og oppdaterer kampene med riktig round og league_logo.
        </p>

        <button id="updateBtn" onclick="updateRounds()">Start oppdatering</button>

        <div id="log"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-auth.js"></script>
    <script src="api-config.js"></script>
    <script type="module">
        import { initHeader } from './header.js';
        initHeader('admin');
    </script>

    <script>
        let logEl;

        window.addEventListener('DOMContentLoaded', () => {
            logEl = document.getElementById('log');
        });

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('no-NO');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logEl.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        async function updateRounds() {
            const btn = document.getElementById('updateBtn');
            btn.disabled = true;
            logEl.innerHTML = '';

            try {
                log('üöÄ Starter oppdatering...', 'info');

                // Wait for Supabase to be initialized
                let attempts = 0;
                while (!window.supabase && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }

                if (!window.supabase) {
                    throw new Error('Supabase ikke initialisert');
                }

                log('‚úÖ Supabase tilkoblet', 'success');

                // 1. Fetch all matches from Supabase
                log('üì• Henter kamper fra Supabase...', 'info');
                const { data: matches, error: fetchError } = await window.supabase
                    .from('matches')
                    .select('*')
                    .order('commence_time', { ascending: true });

                if (fetchError) {
                    throw new Error(`Kunne ikke hente kamper: ${fetchError.message}`);
                }

                log(`‚úÖ Hentet ${matches.length} kamper`, 'success');

                // 2. Group matches by league_id to minimize API calls
                const matchesByLeague = {};
                matches.forEach(match => {
                    if (!matchesByLeague[match.league_id]) {
                        matchesByLeague[match.league_id] = [];
                    }
                    matchesByLeague[match.league_id].push(match);
                });

                log(`üìä Fordelt p√• ${Object.keys(matchesByLeague).length} ligaer`, 'info');

                let totalUpdated = 0;
                let totalFailed = 0;

                // 3. For each league, fetch fixtures from API
                for (const [leagueId, leagueMatches] of Object.entries(matchesByLeague)) {
                    log(`\nüîç Behandler liga ${leagueId} (${leagueMatches.length} kamper)...`, 'info');

                    // Use current date and next 60 days (API-Football only returns future fixtures)
                    const now = new Date();
                    const fromDate = now.toISOString().split('T')[0];
                    const toDate = new Date(now.getTime() + 60 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

                    // Fetch fixtures from API
                    // Use 2024 as season (2024/25 season)
                    const season = 2024;
                    const url = `/api/football?endpoint=fixtures&league=${leagueId}&season=${season}&from=${fromDate}&to=${toDate}`;

                    log(`   üì° Henter fra API: ${fromDate} til ${toDate}`, 'info');

                    try {
                        const response = await fetch(url);
                        if (!response.ok) {
                            log(`   ‚ö†Ô∏è API-kall feilet for liga ${leagueId}`, 'error');
                            continue;
                        }

                        const apiData = await response.json();

                        if (!apiData.response || apiData.response.length === 0) {
                            log(`   ‚ÑπÔ∏è Ingen data fra API for liga ${leagueId}`, 'info');
                            continue;
                        }

                        // Create lookup map: fixture_id -> round info
                        const roundLookup = {};
                        let roundsFound = 0;
                        apiData.response.forEach(fixture => {
                            const roundInfo = {
                                round: fixture.league.round,
                                league_logo: fixture.league.logo,
                                league_name: fixture.league.name
                            };
                            if (roundInfo.round) roundsFound++;
                            roundLookup[fixture.fixture.id] = roundInfo;
                        });

                        log(`   ‚úÖ Hentet ${apiData.response.length} kamper fra API (${roundsFound} med round-info)`, 'success');

                        // Debug: Log first match with round info
                        const firstWithRound = apiData.response.find(f => f.league.round);
                        if (firstWithRound) {
                            console.log('First match with round:', firstWithRound.fixture.id, firstWithRound.league.round);
                        } else {
                            console.warn('No matches have round info in API response!');
                        }

                        // 4. Update each match in Supabase
                        for (const match of leagueMatches) {
                            const roundInfo = roundLookup[match.id];

                            if (!roundInfo) {
                                log(`   ‚ö†Ô∏è Fant ikke round-info for kamp ${match.id}`, 'error');
                                totalFailed++;
                                continue;
                            }

                            if (!roundInfo.round) {
                                log(`   ‚ö†Ô∏è Kamp ${match.id} har round=null i API`, 'error');
                                totalFailed++;
                                continue;
                            }

                            // Update match in Supabase
                            const updateData = {
                                round: roundInfo.round,
                                league_logo: roundInfo.league_logo,
                                league_name: roundInfo.league_name,
                                updated_at: new Date().toISOString()
                            };

                            // Debug: Log first update
                            if (totalUpdated === 0) {
                                console.log('First update data:', match.id, updateData);
                            }

                            const { error: updateError } = await window.supabase
                                .from('matches')
                                .update(updateData)
                                .eq('id', match.id);

                            if (updateError) {
                                log(`   ‚ùå Feil ved oppdatering av kamp ${match.id}: ${updateError.message}`, 'error');
                                totalFailed++;
                            } else {
                                totalUpdated++;
                                if (totalUpdated % 10 === 0) {
                                    log(`   ‚úÖ Oppdatert ${totalUpdated} kamper...`, 'success');
                                }
                            }
                        }

                    } catch (apiError) {
                        log(`   ‚ùå API-feil for liga ${leagueId}: ${apiError.message}`, 'error');
                    }
                }

                log(`\nüéâ FERDIG!`, 'success');
                log(`‚úÖ Oppdaterte kamper: ${totalUpdated}`, 'success');
                if (totalFailed > 0) {
                    log(`‚ùå Feilede kamper: ${totalFailed}`, 'error');
                }
                log(`\nüí° Last index.html p√• nytt for √• se endringene!`, 'info');

            } catch (error) {
                log(`‚ùå FEIL: ${error.message}`, 'error');
                console.error(error);
            } finally {
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
